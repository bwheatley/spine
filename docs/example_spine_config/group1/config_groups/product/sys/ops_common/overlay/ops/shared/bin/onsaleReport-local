#!/usr/bin/perl

use strict;
use warnings;

use Time::Local;
use POSIX;

################## 
# show tarballs? # 

my $tarballs = 0;

##################

sub by_date {
        my $adate = (stat($a))[9];
        my $bdate = (stat($b))[9];
        return $adate <=> $bdate;
}

sub make_table(@) {

        my @list = @_;
        my $list_count = @list;

        open(INDEX, ">/ops/shared/htdocs/todaysOnsales/archives/index.html") || die $!;

        print INDEX "<html>\n";
        print INDEX "<head>\n";
        print INDEX "<title>ticketmaster - todays onsale archives</title>\n";
        print INDEX "<body text=\"black\" bgcolor=\"white\" link=\"darkblue\" vlink=\"darkblue\">\n";
        print INDEX "</head>\n";
        print INDEX "<div align=\"center\">\n";
        print INDEX "<br><br><img src=\"/todaysOnsales/images/bplogo.gif\">\n";
        print INDEX "<br><b>onsale archives</b><br><br><br>\n";
        print INDEX "<table width=\"50%\">\n";

        for(my $x = 0; $x < $list_count; $x++) {

                my $evenodd = $x % 2;

                if($evenodd == 0) {
                        print INDEX "<tr>\n";
                        print INDEX "<td width=\"50%\" align=\"left\" border=\"0\">\n";
                        print INDEX "<a href=\"$list[$x]/index.html\"><b>$list[$x]</b></a>\n";
                        print INDEX "</td>\n";
                }

                if($evenodd == 1) {
                        print INDEX "<td width=\"50%\" align=\"right\">\n";
                        print INDEX "<a href=\"$list[$x]/index.html\"><b>$list[$x]</b></a>\n";
                        print INDEX "</td>\n";
                        print INDEX "</tr>\n";
                }
        }

        print INDEX "</table>\n";
        print INDEX "</div>\n";
        print INDEX "</html>\n";

        close(INDEX);

}

my @time = localtime(time);

$time[0] = 0;
$time[1] = 0;

my $currentHour = $time[2];
my $today = POSIX::strftime('%Y-%b-%d-%a', @time);

if ($currentHour < 12) {

        $currentHour = $currentHour . "am";

} elsif ($currentHour == 12) {

        $currentHour = "12pm";

} elsif ($currentHour > 12) {

        $currentHour = $currentHour - 12;
        $currentHour = $currentHour . "pm";
}

my $endTime = time - 60;
my $startTime = $endTime - 3480;
my $timeYesterday = $endTime - 84600;
my $cluster = `/usr/local/bin/cluster`;
chomp $cluster;

print `
rm -rf /tmp/work/*
mkdir -p /ops/shared/htdocs/todaysOnsales/archives/$today/rrds/$cluster
mkdir -p /tmp/work
ln -s /ops/shared/htdocs/todaysOnsales/archives/$today/rrds/$cluster /tmp/work
cp -r /dev/shm/gmetad/rrds/*/* /ops/shared/htdocs/todaysOnsales/archives/$today/rrds/$cluster
mkdir /ops/shared/htdocs/todaysOnsales/$currentHour
mkdir /ops/shared/htdocs/todaysOnsales/$currentHour/rrds/$cluster
cp -r /ops/shared/htdocs/todaysOnsales/archives/$today/rrds/$cluster /ops/shared/htdocs/todaysOnsales/$currentHour/rrds/$cluster
cd /ops/shared/htdocs/todaysOnsales/$currentHour
/ops/shared/bin/onsaleReport_helper -s $startTime -e $endTime $cluster
cd /ops/shared/htdocs/todaysOnsales/
/ops/shared/bin/onsaleReport_helper -s $timeYesterday -e $endTime $cluster
mv index.html index_postpend.html
cat index_prepend.html index_postpend.html > index.html
cp -r /ops/shared/htdocs/todaysOnsales/$currentHour /ops/shared/htdocs/todaysOnsales/archives/$today
cp /ops/shared/htdocs/todaysOnsales/* /ops/shared/htdocs/todaysOnsales/archives/$today
`;

my $directory = "/ops/shared/htdocs/todaysOnsales/archives";
chdir($directory);
my @unsorted = glob("*");
my @sorted;

foreach my $file (sort by_date @unsorted) {

        if($file eq "index.html") { next; }

        if(!$tarballs) {
                if($file =~ m/tar.gz$/) { next; }
        }

        push(@sorted, $file);

}

make_table(@sorted);
